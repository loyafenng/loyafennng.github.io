<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>html5桌面通知</title>

        <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="css/notice.css">
    </head>
    <body>
        <section id="time_notice">
        <div>
            <p>
                <span>设置提醒主题:</span>
                <input id="content_title" type="text" >
            </p>
            <i class="none">请输入提醒主题</i>
        </div>
        <div>
            <p>
                <span>设置提醒内容:</span>
                <textarea id="content"></textarea>
            </p>
            <i class="none">请输入提醒内容</i>
        </div>
        <div>
            <p>
                <span>设置持续时长:(min)</span>
                <input id="notice_keep" type="text" maxlength="2" value="1">
            </p>
            <i class="none">请输入持续时长</i>
        </div>
        <div>
            <p>
                <span>设置提醒时间:</span>
                <input class="notice_time" type="text" id="time" data-format="HH:mm" data-template="HH : mm" name="datetime">
                <i class="none">请输入提醒时间</i>
            </p>
        </div>
            <p class="btn-group">
                <button id="btn-default" class="btn btn-default">取消</button>
                <button id="btn-success" class="btn btn-success">保存</button>
            </p>
            
        </section>

        <button id="button">有人想加你为好友</button>
        <p id="text"></p>

        <script type="text/javascript" src="js/jquery-1.8.3.js"></script>
        <script type="text/javascript" src="js/moment.js"></script>
        <script type="text/javascript" src="js/combodate.js"></script>
        <script>
        $(function(){
            $('#time').combodate({
                firstItem: 'name', //show 'hour' and 'minute' string at first item of dropdown
                minuteStep: 1
            });  
        });
        </script>
    
        <script type="text/javascript">
        if (window.Notification) {
            var dft = document.getElementById('btn-default'), sucess = document.getElementById('btn-success'), title = document.getElementById('content_title'), content = document.getElementById('content'), dur = document.getElementById('notice_keep'), time = document.getElementById('time'), durationClose, durationOpen,opentime,nowtime,timeArr=[];
            
            var popNotice = function() {
                console.log(Notification.permission)
                if (Notification.permission == "granted") {
                    if(title.value != "" && content.value != ""){
                        var notification = new Notification(title.value, {
                            body: content.value,
                            icon: 'img/logo.jpg'
                        });

                        clearTimeout(timer);
                        var timer = setTimeout(function(){
                            notification.close();
                        },durationClose);

                    }
                    if(time.value ==""){

                    }
                    notification.onclick = function() {
                        // text.innerHTML = '张小姐已于' + new Date().toTimeString().split(' ')[0] + '加你为好友！';
                        notification.close();    
                    };
                }    
            };
            
            sucess.onclick = function() {
                if(time.value != ""){ 
                    var date = new Date();
                    var hour = date.getHours(),
                        minute = date.getMinutes();
                        nowtime = hour * 60 * 60 + minute * 60;
                    timeArr = time.value.split(":");
                    opentime = parseInt(timeArr[0]) * 60 * 60 + parseInt(timeArr[1]) * 60;
                    durationOpen = opentime - nowtime;
                    durationClose = parseInt(dur.value) * 1000 * 60;

                    if (Notification.permission == "granted") {
                        setTimeout(function(){
                            popNotice();
                        },durationOpen * 1000);
                        
                    } else if (Notification.permission != "denied") {
                        Notification.requestPermission(function (permission) {
                          popNotice();
                        });
                    }
                }
            };
        } else {
            alert('浏览器不支持Notification');    
        }
        </script>
    </body>
</html>